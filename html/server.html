<!DOCTYPE html>
<html>
  <head>
    <title>Not Discord</title>
    <link
      rel="icon"
      type="image/jpeg"
      href="https://i.imgur.com/NMChnN8.jpeg"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Geist+Mono:wght@100..900&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <style type="text/tailwindcss">
      @layer base {
        html {
          font-family: "Geist Mono", system-ui, sans-serif;
        }
      }
    </style>
  </head>
  <body class="bg-stone-50 flex h-screen">
    <div
      class="w-64 bg-stone-100 h-full border-r border-stone-300 py-2 flex flex-col flex-nowrap"
    >
      <div class="px-2">
        <a href="/" class="flex-shrink-0 text-sm"><- Home</a>
        <h1
          class="flex-shrink-0 font-semibold my-3 text-lg"
          id="serverName"
        ></h1>
      </div>
      <div
        class="flex-grow overflow-auto min-h-34 pb-2 text-sm flex flex-col space-y-2 px-2"
        id="channels"
      ></div>
      <button
        class="flex-shrink-0 mx-2 py-2 bg-stone-100 hover:bg-stone-200 border border-stone-300"
      >
        New Channel
      </button>
    </div>
    <div class="flex-1 h-full">
      <div class="h-full w-full flex flex-col flex-nowrap">
        <div class="flex-shrink-0 p-2">
          <p class="text-xl">Messages</p>
        </div>
        <div
          class="flex-grow overflow-auto min-h-34 mt-4 flex flex-col-reverse px-4"
          id="messagesContainer"
        ></div>
        <div class="flex-shrink-0 h-20 flex items-center p-2 pt-6">
          <form class="flex gap-1 w-full" onsubmit="sendMessage(event)">
            <input
              id="messageInput"
              class="flex flex-1 bg-stone-100 px-2 border border-stone-300 focus:outline-none focus:ring-1 ring-amber-400"
              placeholder="Enter your message"
              required
            />
            <button
              id="sendButton"
              class="px-4 w-48 bg-amber-500 h-10 hover:bg-amber-600"
            >
              Send
            </button>
          </form>
        </div>
      </div>
    </div>
  </body>

  <script>
    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    const serverId = urlParams.get("id");
    const channelId = urlParams.get("channel");

    async function getChannels() {
      const resp = await fetch(`/api/channels?server=${serverId}`);
      return await resp.json();
    }
    const channelsResult = getChannels();

    async function getUser() {
      const resp = await fetch("/api/user");
      return await resp.json();
    }
    const userResult = getUser();
    async function getMessages() {
      const resp = await fetch(`/api/messages?channel=${channelId}`);
      const jsonResp = await resp.json();
      return jsonResp;
    }
    const messagesResult = getMessages();
    async function getServerData() {
      const resp = await fetch(`/api/server?id=${serverId}`);
      const jsonResp = await resp.json();
      return jsonResp;
    }
    const serverDataResult = getServerData();

    async function sendMessage(e) {
      e.preventDefault();
      const button = document.getElementById("sendButton");
      button.disabled = true;
      const messageInput = document.getElementById("messageInput");
      const response = await fetch("/api/messages/new", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          channelId,
          message: messageInput.value,
        }),
      });
      if (response.ok) {
        messageInput.value = "";
        const message = await response.json();
        addMessageToDom(message);
      }
      button.disabled = false;
    }
    function addMessageToDom(message) {
      const createdAt = new Date(message.createdAt * 1000);
      const authorId = message.authorId;
      console.log(authorId, user.id);
      document.getElementById("messagesContainer").innerHTML =
        `<div class="${
          authorId === user.id ? "min-w-[55%] ml-auto mt-4" : "max-w-[55%] mt-4"
        }">
          <p class="text-xs text-right">${createdAt.toLocaleString()}</p>
          <p class="mt-1 text-sm border border-stone-200 bg-stone-100 p-2">
            ${message.content}
          </p>
        </div>` + document.getElementById("messagesContainer").innerHTML;
    }
    async function addChannelToDom(channel) {
      document.getElementById("channels").innerHTML += `<a href="#" class="${
        channel.id === channelId
          ? "bg-stone-200 p-2"
          : "hover:bg-stone-200/50 p-2"
      }">${channel.name}</a>`;
    }
    let user;
    document.addEventListener("DOMContentLoaded", async function () {
      user = await userResult;
      const channels = await channelsResult;
      channels.forEach(addChannelToDom);
      const messages = await messagesResult;
      messages.forEach(addMessageToDom);

      const serverData = await serverDataResult;
      document.getElementById("serverName").textContent = serverData["name"];
    });
  </script>
</html>
