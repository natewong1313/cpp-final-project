<!DOCTYPE html>
<html>
  <head>
    <title>Not Discord</title>
    <link
      rel="icon"
      type="image/jpeg"
      href="https://i.imgur.com/NMChnN8.jpeg"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Geist+Mono:wght@100..900&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <style type="text/tailwindcss">
      @layer base {
        html {
          font-family: "Geist Mono", system-ui, sans-serif;
        }
      }
    </style>
  </head>
  <body class="bg-stone-50 flex h-screen">
    <div class="w-64 bg-stone-100 h-full border-r border-stone-300 p-2">
      <a href="/" class="text-sm"><- Home</a>
      <h1 class="font-semibold my-3 text-lg" id="serverName"></h1>
      <div class="text-sm flex flex-col space-y-2">
        <a href="#" class="bg-stone-200 p-2">General</a>
        <a href="#" class="hover:bg-stone-200/50 p-2">Random</a>
      </div>
    </div>
    <div class="flex-1 h-full">
      <div class="h-full w-full flex flex-col flex-nowrap">
        <div class="flex-shrink-0 p-2">
          <p class="text-xl">Messages</p>
        </div>
        <div
          class="flex-grow overflow-auto min-h-34 space-y-4 mt-4 flex flex-col-reverse px-4"
          id="messagesContainer"
        ></div>
        <div class="flex-shrink-0 h-20 flex items-center p-2 pt-6">
          <form class="flex gap-1 w-full" onsubmit="sendMessage(event)">
            <input
              id="messageInput"
              class="flex flex-1 bg-stone-100 px-2 border border-stone-300 focus:outline-none focus:ring-1 ring-amber-400"
              placeholder="Enter your message"
            />
            <button
              id="sendButton"
              class="px-4 w-48 bg-amber-500 h-10 hover:bg-amber-600"
            >
              Send
            </button>
          </form>
        </div>
      </div>
    </div>
  </body>

  <script>
    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    const serverId = urlParams.get("id");

    async function getUser() {
      const resp = await fetch("/api/user");
      return await resp.json();
    }
    const userResult = getUser();
    async function getMessages() {
      const resp = await fetch(`/api/messages?server=${serverId}`);
      const jsonResp = await resp.json();
      return jsonResp;
    }
    const messagesResult = getMessages();
    async function getServerData() {
      const resp = await fetch(`/api/server?id=${serverId}`);
      const jsonResp = await resp.json();
      return jsonResp;
    }
    const serverDataResult = getServerData();

    async function sendMessage(e) {
      e.preventDefault();
      const button = document.getElementById("sendButton");
      button.disabled = true;
      const messageInput = document.getElementById("messageInput");
      const response = await fetch("/api/messages/new", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          serverId,
          message: messageInput.value,
        }),
      });
      if (response.ok) {
        messageInput.value = "";
        const message = await response.json();
        addMessageToDom(message);
      }
      button.disabled = false;
    }
    function addMessageToDom(message) {
      const createdAt = new Date(message.createdAt * 1000);
      const authorId = message.authorId;
      console.log(authorId, user.id);
      document.getElementById("messagesContainer").innerHTML =
        `<div class="${
          authorId === user.id ? "min-w-[50%] ml-auto" : "max-w-[50%]"
        }">
          <p class="text-xs text-right">${createdAt.toLocaleString()}</p>
          <p class="mt-1 text-sm border border-stone-200 bg-stone-100 p-2">
            ${message.content}
          </p>
        </div>` + document.getElementById("messagesContainer").innerHTML;
    }
    let user;
    document.addEventListener("DOMContentLoaded", async function () {
      user = await userResult;
      const messages = await messagesResult;
      console.log(messages);
      messages.forEach((element) => {
        addMessageToDom(element);
      });

      const serverData = await serverDataResult;
      document.getElementById("serverName").textContent = serverData["name"];
    });
  </script>
</html>
